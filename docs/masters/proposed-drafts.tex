% vim: spelllang=en spell textwidth=120
\documentclass[trojita]{subfiles}

\begin{document}

\chapter{Proposed Extensions}

Previous chapters have shed some light on the complicated world of IMAP and showed how the protocol limitations affects
the users' experience.  I have also introduced some of the existing extensions which aim to address many shortcomings.
There are still quite a few issues which make lives of the client implementors harder than necessary, though.  At this
point, I present three extensions which fix race conditions, improve the effectiveness of the protocol or add new
features which contribute to smoother operation of the e-mail clients.  This broad range of changes was selected to
illustrate that improving IMAP can happen on many different levels.

Internet Drafts are usually prepared in a special system \cite{rfc-formatting} which handles the required strict
document formatting using ASCII art.  This chapter is therefore purposely very short, providing only the minimal
descriptions of the proposed extensions.  The Internet Drafts themselves are found in appendix \ref{sec:id-manuscripts}
on page \pageref{sec:id-manuscripts} and are an integral part of this thesis.

\section{Announcing UIDs of Newly Arriving Messages in QRESYNC: the ARRIVED Extension}
\label{sec:draft-arrived}

The first extension I have implemented addresses a race condition in the {\tt QRESYNC} extension \cite{rfc5162}.  In
{\tt QRESYNC}, the offset-based {\tt EXPUNGE} responses known from the baseline IMAP protocol are replaced by {\tt
VANISHED} responses which use UIDs.  Unfortunately, because the {\tt EXISTS} still informs about the number of new
deliveries only, without including the UIDs, and due to the fact that the IMAP server is explicitly
allowed~\footnote{{\em``Note that a VANISHED response caused by EXPUNGE, UID EXPUNGE, or messages expunged in other
connections SHOULD only contain UIDs for messages expunged since the last VANISHED/EXPUNGE response sent for the
currently opened mailbox or since the mailbox was opened.  That is, servers SHOULD NOT send UIDs for previously expunged
messages, unless explicitly requested to do so by the UID FETCH (VANISHED) command.''

``Note that client implementors must take care to properly decrement the number of messages in the mailbox even if
a server violates this last SHOULD or repeats the same UID multiple times in the returned UID set.  In general, this
means that a client using this extension should either avoid using message numbers entirely, or have a complete mapping
of UIDs to message sequence numbers for the selected mailbox.''}~\cite[p. 12]{rfc5162} --- in the
RFC language, {\em SHOULD} means that implementations are suggested to use the recommended behavior, but can deviate
from that as {\em ``there may exist valid reasons in particular circumstances to ignore a particular item''}
\cite{rfc2092}.} to include non-existing UIDs in the {\tt VANISHED} responses, a race condition exists where client does
not know about the full value of the sequence $\rightarrow$ UID mapping, which in turn violates RFC 5162's requirement
on clients having {\em ``a complete mapping of UIDs to message sequence numbers for the selected mailbox''}.

The proposed extension addresses this issue through the {\tt ARRIVED} response.  At the same time, it improves the
protocol efficiency by freeing the clients from a requirement to explicitly ask for message UIDs when a new message is
delivered.

In absence of the {\tt ARRIVED} extension, clients are required to perform an explicit UID rediscovery.  Servers which
already do not send non-existing UIDs in the {\tt VANISHED} responses will still benefit from implementing the {\tt
ARRIVED} response as the clients will not have to perform explicit {\tt UID SEARCH} operations on them upon new
deliveries.

Full text of the proposed extension in the format of an Internet-Draft suitable for IETF submission is included in
section \secref{sec:draft-imap-qresync-arrived}.

\section{Improving Incremental Threading through Modified INTHREAD}
\label{sec:draft-inthread-ext}
\todo[inline]{Incremental threading}

\section{Submitting Internet Mail --- the SENDMAIL Extension}
\label{sec:draft-sendmail}

Message submission is one of the controversial subjects, along the ``imap5'' and ``move messages'' discussions ---
whenever any of these topics is brought up on the imap-protocol mailing list, an interesting discussion is guaranteed to
happen.  In this proposal, I have tried to accommodate criticism from many previous review rounds.

The baseline IMAP protocol does not offer any way of e-mail submission.  Mail User Agents willing to send mail are
supposed to use the (E)SMTP protocol \cite{rfc5321} \cite{rfc2821}, preferably over a dedicated submission service
\cite{rfc6409}.  This is how most of contemporary e-mail clients (at least those using the IETF standards in contrast
to the proprietary ones) work, but it also brings along a set of issues.

First of all, the clients have to be {\em properly configured}.  Given that ESMTP and IMAP can be (and often are)
managed separately, clients have to ask their users for two sets of accounts, one for each type of service.  Proposals
exist trying to eliminate much of this complexity, especially through the DNS system \cite{rfc6186} or via non-standard
mechanisms like those proposed by Mozilla \cite{mozilla-ispdb} --- but as usual, these mechanisms often cover only a
subset of service providers.  Client programmers are required to implement and test full support for both protocols.
IMAP is doubtlessly the more complicated one, exceeding ESMTP both in syntax and semantic, yet adding a requirement for
a proper SMTP implementation causes a measurable burden on the developers.

Furthermore, network firewalls and other filters along the way have to be properly configured to allow for a reliable
pass-through for both services \cite{crocker-beep-multi-conns}.  Even though the situation has much improved with a
dedicated ``Submission'' service \cite{rfc6409} which moved the e-mail submission to a dedicated port to not interfere
with the traditional SPAM-laden TCP port 25, there are still certain situations where customers cannot use both e-mail
services, leading to confused support calls \cite{submission-users-suck-smtp-imap} \cite{panozzo-submission-users-suck}.

In addition to the above, many users wants to store their outgoing e-mail in a separate IMAP mail folder.  This means
that under typical circumstances, a message being sent has to be uploaded twice over the network, once for IMAP, the
second time for ESMTP delivery.  In case when a message contains an attachment previously already available on the IMAP
server, the same data can in fact travel over the network {\em three times} -- at first when being downloaded by the
IMAP client only to be subsequently sent after the proper MIME encapsulation to the destined ``Sent'' folder, and
finally over SMTP as usual.  As a last point in this quick list, even in presence of specific extensions, the time
required to actually {\em establish} a separate connection, setup proper TLS confidentiality and start tunnelling data
over it is often non-negligible.

All of the above suggests that there are certain benefits in choosing to deliver e-mail messages from
MUAs~\footnote{Mail User Agents} over IMAP.

\subsection{Competing Proposals}

Over the years, many proposals have appeared trying to accommodate this issue.

\subsubsection{The ``Lemonade Trio''}

The most widely deployed mechanism aiming at bandwidth reduction is the Lemonade extension family \cite{rfc5550}.
Through the use of IMAP's {\tt CATENATE} \cite{rfc4469} and {\tt URLAUTH} \cite{rfc4467} along with SMTP's BURL
\cite{rfc4468}, conforming clients can:

\begin{itemize}
  \item compose a message on the IMAP server's side, reusing any existing data,
  \item deliver that message over SMTP without having to upload the data.
\end{itemize}

At the same time, this approach has the following disadvantages:

\begin{itemize}
  \item a trust relation (at least a limited one) has to exist between the SMTP and IMAP servers,
  \item both SMTP and IMAP servers have to be properly configured,
  \item clients still have to maintain a separate SMTP protocol stack,
  \item an extra connection has to be opened.
\end{itemize}

Trojit치 includes full support for these extensions.  However, because there is {\em no} way of discovering whether the
IMAP and SMTP daemons ``trust'' each other,~\footnote{The mere presence of the {\tt URLAUTH} capability on the IMAP
server side and the advertised {\tt BURL} extension by the ESMTP service does not imply that an eventual submission will
succeed.} Trojit치 requires the user to explicitly enable a checkbox in the settings dialog to activate these
features.~\footnote{The {\tt CATENATE} extension is not subject to this limitation; it will be used whenever the server
announces its presence, unless the user has explicitly forbidden its usage.  This is equivalent to how Trojit치 handles
any other IMAP extension.}  Using this explicit confirmation is intended to deter bugs like those which have plagued
other MUA implementations \cite{qmf-fastmail-burl-bug} from affecting Trojit치.  This implementation might change in
future.

\subsubsection{Tunneling SMTP inside IMAP}

A second approach in which the IETF community and related researchers have tried to tackle down the e-mail submission
was via actually tunneling the real ESMTP session through the IMAP protocol \cite[p. 30]{draft-maes-lemonade-p-imap}.
This approach removes the burden of establishing a second connection, but retains the required complexity of having to
ship and test a full ESMTP client stack.  This approach is {\em by definition} as flexible as any future ESMTP extension
and does not require any changes on the (ESMTP) server side (besides support for SMTP pipelining \cite{rfc2920}), with
only a limited amount of modifications for the IMAP clients.  On the other hand, the requirement to tunnel a second
protocol through IMAP adds a lot of complexity to their interaction and it appears that either the IMAP daemon or the
SMTP server has to include support for BURL nonetheless.  One has to wonder if the ESMTP serialization, no matter how
useful when speaking ESMTP, can be replaced with something terser.  Consider the following example from the proposed
draft:

\begin{minted}{text}
  C: a004 XDELIVER CAPABILITY
  S: * XDELIVER CAPABILITY (8BITMIME EXPN HELP)
  C: a005 XDELIVER TEXT {123+}
  C: EHLO
  C: MAIL FROM: john@smith.com
  C: RCPT TO: mooch@owatagu.siam.edu
  C: DATA
  C: URL /Inbox;UIDVALIDITY=9999/;UID=33;Section=BODY
  .
  S: * XDELIVER {321}
  S: 220 mail.metastructure.net ESMTP
  S: 250-mail.metastructure.net
  S: 250-AUTH LOGIN CRAM-MD5 PLAIN
  S: 250-AUTH=LOGIN CRAM-MD5 PLAIN
  S: 250-PIPELINING
  S: 250 8BITMIME
  S: 250 ok
  S: 250 ok
  S: 354 go ahead
  S: 250 ok 1126337586 qp 28229
\end{minted}

This communication is indeed rather verbose.  The same result is achieved in a clearer way through the {\tt UID SUBMIT}
command I propose later in this chapter.

No known deployments of these drafts exist and no further standardization process has been observed on the relevant
mailing lists.

\subsubsection{The POSTADDRESS Draft}

For the sake of completeness, one should also mention the {\tt POSTADDRESS} draft
\cite{draft-melnikov-imap-postaddress}.  This extension tried to provide a way for servers to announce an Internet
e-mail address for each mailbox which could act as the ``Sent'' folder.  The idea behind this proposal was that clients
should obtain this e-mail address and include it in the {\tt Bcc} field of the outgoing e-mail messages.  Doing so would
facilitate the same result as the {\tt APPEND} command, but without having to send the data explicitly.  Drawbacks of
this method included privacy concerns and the fact that this extension might not work with Sieve or other server-side
filtering \cite{postaddress-sieve}.  As of July 2012, this idea appears to have been abandoned for good.

\subsection{The SENDMAIL Extension}

\todo[inline]{My contribution}

\end{document}
