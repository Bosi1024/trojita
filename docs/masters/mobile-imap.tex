% vim: spelllang=en spell textwidth=120
\documentclass[trojita]{subfiles}

\begin{document}

\chapter{The Mobile IMAP}
\label{sec:mobile-imap}

Many of the existing IMAP extensions discussed in \secref{sec:imap-extensions} have the potential of improving the
client's operation tremendously.  At the same time, experience has shown that there is a certain chicken-and-egg problem
with new proposals where server vendors are not willing to invest their time into promising extensions which no client
supports yet and clients are not interested in implementing extensions which they cannot test for interoperability.  In
this chapter, I am trying to provide a concise summary of individual merit of these extensions.

\section{The Lemonade Profile}
\label{sec:lemonade-comparison}

The Lemonade profile, as defined in RFC 4550 \cite{rfc4550} in 2006 and later updated through RFC 5550 \cite{rfc5550}
during 2009, provides a list of extensions considered ``critical'' for any mobile IMAP e-mail client.  The set of
mandatory extensions is rather big, though, and to the best of my knowledge, there is {\em no} server on the market
implementing all of the compulsory features.  One might therefore wonder what were the reasons for this lack of general
availability of the Lemonade extension family.

\subsection{Cross-Service Requirements}

One unique feature of Lemonade is the possibility to {\em forward messages without their prior download}.  The three
ESMTP~\cite{rfc5321} and IMAP extensions, often referred to as the {\em Lemonade trio}, namely the {\tt CATENATE}, {\tt
URLAUTH} and {\tt BURL}, allow the clients to compose a message using existing parts available from the IMAP mail store,
provide a way of generating single-purpose ``pawn tickets'' for making the composed messages available to the submission
server, and replacing the {\tt DATA} SMTP command with a way of downloading the message from the IMAP server,
respectively.  This feature prevents having to transfer potentially huge data over the network three times --- once when
the users wants to read it, second time when the message is saved to the sent folder, and finally when delivering via
SMTP.

Unfortunately, a big problem with said approach is the fact that it mandates collaboration across different services ---
an explicit trust path between the IMAP and ESMTP servers have to be set up, which is a process prone to errors
\cite{qmf-fastmail-burl-bug}.  This matter is also complicated by the fact that no open source MTA~\footnote{Mail
Transfer Agent, typically an SMTP or ESMTP server} ships with official support for {\tt BURL}.~\footnote{Unofficial
patches exists for Postfix dating back to 2010 \cite{apple-postfix-burl}, but they have not been integrated into the
mainline version as of July 2012 (the {\tt postfix-2.10-20120715.tar.gz} development snapshot.}  Situation is better on
the IMAP server front with Cyrus supporting the {\tt URLAUTH} and {\tt CATENATE} extensions out-of-box with Dovecot's
support scheduled for its upcoming 2.2 release \cite{imap-server-extension-matrix}.

\subsection{Complicated Extensions}

Some of the extensions whose support is mandated by the Lemonade proposal seems to be notoriously hard for the server
vendors to implement.

A perfect example is the {\tt CONTEXT=SORT} extension \cite{rfc5267}.  As a client developer, I recognize its extreme
usefulness and appreciate its design.  Availability of such an extension would make it extremely easy to implement
live-updated sorting in my Trojitá (and Trojitá {\em does} make use of the sort context extension).  That said, given
that no IMAP server which I am aware of announces its availability, clients have to deal with the status quo in the
meanwhile.

The {\tt CONVERT} extension \cite{rfc5259} belongs to a similar category --- the features it offers, like the
server-side downscaling of JPEG images, would be {\em very} handy on a cell phone, yet no IMAP server known to the
author includes that functionality.

Both of these RFCs were published four and five years ago, respectively, and were designed by engineers working for an
IMAP server vendor.  One cannot therefore dismiss them altogether as a product of people not having any say in the
server development.  My opinion is that the allocation of engineering resources required for shipping a particular
feature in a finished product is based on another criteria than the research activity.

\section{State of Other Client Implementations}

To obtain a better understanding on how the existing solutions available on the market today use IMAP, this section
takes a look at some of the most popular solutions.

\subsection{Apple iOS}

Apple's devices generally ship with a decent implementation of their IMAP stack, an evaluation shared by independent
researchers \cite{isode-iphone4}.  The list of extensions supported by the application includes {\tt CONDSTORE} and {\tt
ESEARCH} for improved mailbox synchronization, {\tt COMPRESS} for transparent deflate compression and {\tt BURL} for the
forward-without download.

It is, however, surprising that their support of extensions aimed at making mailbox resynchronization more efficient
does not include the {\tt QRESYNC} extension \cite{rfc5162}, especially given that its implementation does not impose
much in terms of additional requirements on top the already-supported {\tt CONDSTORE}.

The iOS also notably does not use the {\tt IDLE} command at all.  The reason, according to a message allegedly sent by
Steve Jobs \cite{jobs-ios-idle}, is that is is {\em ``a power hungry standard''}.  Systematic measurements
\cite{wcdma-energy} \cite{cridland-fach-dch-measurements} and experience alike~\footnote{Mark Crispin's famous {\em ``I
have built on-demand networks which shut down until signaled back on, and then happily resumed all the active TCP
sessions even though the "network connection" had been powered off for days.''} \cite{crispin-no-ifup}.} shows, however,
that the mere act of having a TCP connection open with an occasional keep alive ``pings'' being transfered have no
significant impact on battery life on other platforms.

\subsection{Android's Native E-mail Client}

There is not much to be said about Android's native client's IMAP performance --- the stock client does not offer push
notification through {\tt IDLE} \cite{android-idle} and the list of extension identifiers referenced from the
application's source~\footnote{File \path{src/com/android/email/mail/store/ImapConnection.java} from Android's
\path{platform/packages/apps/Email} repository as of the {\tt android-4.1.1\_r3-35-g01c55fd} revision.} only references
the {\tt NAMESPACE}, {\tt UIDPLUS} and {\tt STARTTLS} capabilities.  None of the extensions which try to improve
synchronization performance (the {\tt ESEARCH}, {\tt CONDSTORE} and {\tt QRESYNC}) are available.  No provisions for
Lemonade's family are present at all.  The {\tt LITERAL+}, an extension which takes literally no effort for clients to
support and removes one network round trip when uploading messages, is not supported.

Further analysis shows that the code is blocking and incapable of issuing or processing requests in parallel.  These
observations are consistent with what users generally describe as a ``slow'' experience.  This might not come surprising
given that Google would likely prefer its users to choose Google's own e-mail offering, the GMail, over various private
IMAP accounts for business reasons.

\subsection{Android's K-9 Mail}

The Android's K-9 mail~\cite{k9mail} is a fork of the original e-mail application from Google.  The developers have
managed to add support for two extensions, namely the {\tt IDLE} and the {\tt COMPRESS=DEFLATE}.  More advanced features
like the {\tt ESEARCH} / {\tt CONDSTORE} / {\tt QRESYNC} are however still missing.

Furthermore, comments like {\em ``TODO Need to start keeping track of UIDVALIDITY''}~\footnote{File
\path{src/com/fsck/k9/mail/store/ImapStore.java}, line 103 as of the Git revision {\tt 3.512-1249-g5ce0e19} of the K-9's
source code repository.} might make one feel nervous about the safety of the data being accessed.

\subsection{Modest / Tinymail}

The several years old Nokia N900 shipped with a mail client called Modest, an application based on top of the Tinymail
framework~\cite{tinymail}.  The underlying library supports an efficient mailbox synchronization through {\tt QRESYNC}
and the sources contain a reference to the {\tt CONVERT} extension --- however, this functionality appears to be limited
and in an early state.  The ``Lemonade trio'' for forwarding without download is not supported.

The code is written using the synchronous idioms. No support for command pipelining is present.

\subsection{Nokia's Qt Messaging Framework}

Nokia's Qt Messaging Framework~\cite{qmf} powers the e-mail functionality in the MeeGo Harmattan line of phones, the N9
and the N950.  Support for extensions appears to be rich --- the Lemonade trio is supported in its
entirety,~\footnote{An interesting detail is that the {\tt BURL} extension is disabled if the account is configured to
use IMAP over an SSL port instead of the {\tt STARTTLS}; this is caused by a deficiency in the IMAP-URL standard
\cite{rfc5092}.} as well as are the {\tt COMPRESS=DEFLATE}, {\tt BINARY}, {\tt IDLE}, {\tt CHILDREN} and many others.

The underlying IMAP library exhibits regular ``batched synchronization'' mode of operation; connections to mailboxes are
typically not left alone for long, but the code makes aggressive use of the {\tt QRESYNC} extension to benefit from
extremely cheap mailbox synchronization.  Code is written with memory-constrained devices in mind, care is taken to
prevent data copying if possible.  The general behavior focuses on making the specified subset of messages always
available on device --- there is no support for server-side threading or sorting, but some form of a server-side search
{\em is} available.  Live updates through {\tt CONTEXT=SEARCH} are not employed.  Support for the {\tt LIST-STATUS} is
not available.

An interesting extension which is supported by the QMF is Google's {\tt XLIST} \cite{gmail-xlist} extension.  However,
the code~\footnote{File \path{src/plugins/messageservices/imap/imapprotocol.cpp} as of QMF's Git revision {\tt
2011W26\_2-263-gec26531}.} appears to only use the {\tt \\Inbox} mailbox flag for forcing case-insensitive mailbox
comparison, a mechanism already mandated by the baseline IMAP protocol \cite[p. 17]{rfc3501}.

All in all, the Qt Messaging Framework is a promising library with support for other protocols besides IMAP.  Its IMAP
implementation feels solid and is reasonably well covered by the unit tests.

\subsection{Trojitá}

Trojitá~\cite{trojita-website} is an advanced IMAP client which includes support for many different extensions from the
basic ones like {\tt IDLE}, {\tt LITERAL+} or the {\tt ID} extension to the complex ones like the Lemonade trio or the
{\tt ESEARCH} / {\tt CONDSTORE} / {\tt QRESYNC} triplet.  Trojitá can scale up to company-wide ERP-level e-mail
processing (appendix \ref{sec:xtuple}, p. \pageref{sec:xtuple}) while still using the same code base of
the underlying IMAP library as the desktop and cell phone version.

\section{Evaluating Extensions}

As the previous section shows, the level of support for various extensions and their real-world deployment varies
wildly.  Many today's clients are using only a limited subset of features which are generally available, leaving
opportunities for new applications entering the market to offer smoother, more efficient user experience.

Previous efforts aimed at standardizing a set of extensions to serve as a ``mobile profile'' of IMAP have not delivered
a universally acceptable result.  Lemonade, a specification universally considered to be {\em the} specification to go
when evaluating clients and servers alike \cite{isode-lemonade}, mandates a set of extensions which --- to the best of
my knowledge --- is not available on any single IMAP server in its entirety.  Furthermore, the clients do not even
attempt to use these extensions, probably due to not being able to verify them for interoperability and because of
concerns about shipping something which could very well be considered a dead code.

The rest of this chapter tries to look at the available extensions through the optics of a client developer who is
trying to push the IMAP server developers slightly, but not too much --- pushing forward is crucial in attaining a
sustainable development, yet applying too much pressure often leads to the whole movement getting stuck on a first
obstacle.

\subsection{The Bare Minimum}

The first group of extensions lists those proposals which I consider to be a practical requirement for a well-behaving
client to implement.  Furthermore, their implementation does not impose an overly significant burden on the servers,
neither in terms of complicated code and therefore increased development costs, nor in the runtime overhead.

\todo[inline]{literal+, idle,\ldots}

\subsection{Useful Extensions}

\todo[inline]{condstore, qresync, sort, thread, sendmail,\ldots}

\subsection{The Icing on a Cake}

\todo[inline]{convert, context, catenate, urlauth, burl, notify,\ldots}

\end{document}
