% vim: spelllang=en spell textwidth=120
\documentclass[trojita]{subfiles}

\begin{document}

\chapter{IMAP Extensions}
\label{sec:imap-extensions}

\begin{abstract}
  Previous chapter has outlined the generic mode of operation of the IMAP protocol and provided an overview of what
  features are available.  In this chapter, we will talk about how to improve on the basic functionality through the
  optional extensions.
\end{abstract}

It might be concluded from the brief analysis presented in the previous chapter that a few feature of IMAP are rather
limiting in its real-world deployment.  Fortunately, the IMAP protocol includes built-in support of extensions which
allow rather substantial changes to the network communication.

\section{Optimizing the Protocol}

Before dwelling into more advanced topics like improving the synchronization performance or adding new features, let's
have a look at the basic layer of the IMAP protocol and investigate how these affect performance.

\subsection{The LITERAL+ Extension}
\label{sec:imap-literalplus}

One of the lowest-hanging optimization fruit to cater are IMAP's synchronizing literals.  In the basic IMAP, before a
clients proceeds with tasks involving upload of binary data (or any data over a certain size, for that matter), it has
to ask for an explicit server's approval based on the length of the data in question.  As we have shown previously, this
confirmation imposes a full round trip over the network, inducing latency and destroying any potential pipelining
improvements.

The LITERAL+ extension (RFC~2088~\cite{rfc2088}) simply lifts the requirement of having to wait for the server's
continuation requests by a subtle change of the syntax.  Adding an overhead of just one byte, the latency is completely
eliminated and communication gets rapidly streamlined.  We can go as far as to say that the code paths for dealing with
LITERAL+ data are actually simpler than having to deal with the old-fashioned synchronizing literals.  Consider the
following example:

\begin{minted}{text}
  S: * OK
  C: A001 LOGIN {11}
  # The client has to wait for server's response before proceeding any further
  S: + go ahead
  C: FRED FOOBAR {7}
  # A second round-trip wait occurs here
  S: + go ahead
  C: fat man
  S: A001 OK LOGIN completed
\end{minted}

When using the LITERAL+ syntax, the whole interaction happens without having to wait for the server:

\begin{minted}{text}
  S: * OK
  C: A001 LOGIN {11+}
  C: FRED FOOBAR {7+}
  C: fat man
  S: A001 OK LOGIN completed
\end{minted}

Trojitá includes full support for the LITERAL+ extension -- when it detects the {\tt LITERAL+} capability, it will
immediately switch to using non-synchronizing literals for increased performance.

\subsection{Data Compression}

IMAP is a textual, line-based protocol.  As such, it presents extremely good opportunities for compression -- using the
tried DEFLATE algorithm~\cite{rfc1951}, the basic IMAP chatter can be easily compressed to 25~-~40~\% of its original
size~\cite[p. 4]{rfc4978}.

RFC~4978~\cite{rfc4978} provides mechanism for exactly this functionality through the {\tt COMPRESS=DEFLATE} capability.
Trojitá ships with full support for this extension through the permissively licensed {\tt zlib} library.  Unfortunately,
the Qt's {\tt QSslSocket} currently doesn't provide a way to reliably tell whether the SSL connection is already
employing compression.  When combined with IMAP servers hidden behind SSL accelerators or load balancers (i.e. in
situations where the server does not have a clear idea whether the session is already compressed either), this has a
risk of needlessly trying to compress data twice.  This is a limitation in system libraries which cannot be overcome
without resorting to patching system components or conducting non-portable hacks.

\subsection{Improving Security through Cryptography}

RFC~2595~\cite{rfc2595} deals with best practices for establishing SSL/TLS connections to the IMAP server.  Trojitá
follows these recommendations, most notably it tries to establish a secure channel over {\tt STARTTLS} command even
without an explicit action on the user's side, should the server be configured to advertise itself as not accepting
logins over insecure connections through the {\tt LOGINDISABLED} capability.  A manual override is available in
situations where the SSL encryption is not available.

In advent of the recent breaches of many well-known (and widely trusted) Certificate Authorities~\cite{ssl-breaches},
Trojitá also comes with support for SSL key pinning~\cite{ssl-pinning}.  The trust model presented to the user is
similar to handling of SSH servers' public keys with OpenSSH -- upon first connection, the user is always presented with
a choice of whether to accept the certificate or not, along with a confirmation about whether the operating system and
its policy considers the certificate as ``trusted''.  No matter what the system-wide policy says, a changed public key
is always considered a threat and the situation is presented to the user accordingly.

\subsection{The IDLE Mode}
\label{sec:imap-idle}

We have mentioned that even though the protocol requires clients to be ready to accept any responses at any time, in
practice, servers are forbidden to send {\tt EXPUNGE}s when no command is in progress.  This requirement is necessary to
prevent a dangerous resynchronization as the server cannot possibly know whether the client has started to issue an
UID-less {\tt STORE} command which references messages through their sequence numbers.  Unfortunately, this directly
translates to clients having to {\em poll} the server quite often if they care about updates concerning the deleted
messages.

Any protocol which uses polling looks bad on paper -- having to poll leads to increased latency and higher power usage
because the equipment has to actively check for updates every now and then.  In contrast, {\em push-based} updates allow
the client to enter a low-power state where it merely waits to be woken up when a change occurs.  Such a mode is exactly
what the IDLE extension defined by RFC~2177~\cite{rfc2177} adds to IMAP.  It must, however, be said that real-world
concerns related to firewall timeouts and especially the NAT traversal has limited the usefulness of the IDLE command
somewhat, even to the extent where Mark Crispin, the original author of the IMAP protocol, claims that ``I see no
particular benefit to use of IDLE on a desktop machine''~\cite{crispin-idle-useless} -- a view which is not shared by
the wider community~\cite{tss-idle-keepalive} \cite{android-idle}, yet certainly worth a consideration.

The IDLE extension is basically a hack on top of the IMAP protocol which reverses the ``A command is not "in progress"
until the complete command has been received; in particular, a command is not "in progress" during the negotiation of
command continuation.``~\cite[p. 72]{rfc3501} mantra of the basic IMAP specification.  With IDLE, a typical interaction
might look like this one:

\begin{minted}{text}
  C: A004 IDLE
  S: * 2 EXPUNGE
  S: * 3 EXISTS
  S: + idling
  ...time passes; another client expunges message 3...
  S: * 3 EXPUNGE
  S: * 2 EXISTS
  ...time passes; new mail arrives...
  S: * 3 EXISTS
  C: DONE
  S: A004 OK IDLE terminated
  C: A005 FETCH 3 ALL
  S: * 3 FETCH (...)
  S: A005 OK FETCH completed
  C: A006 IDLE
\end{minted}

The whole effect of the {\tt IDLE} command is therefore to indicate to the server that the client is {\em really}
willing to listen for any updates to the mailbox state.  Because of compatibility concerns with legacy mail stores, the
IDLE extension still does {\em not} mandate the server to actually send updates about any changes as soon as they are
conducted -- indeed, a server which internally polls every fifteen minutes to check whether a message has arrived is
fully compliant with the IDLE extension, albeit rather useless to user who might expect (and, we might add, rightly so)
to be {\em instantly} notified about changes to the mailbox.

Trojitá includes full support for the IDLE extension and will enter that mode automatically shortly after a mailbox is
selected.  A simple heuristics is implemented which delays re-entering the IDLE command if it is likely that the
connection will be reused for any other purpose in near future, further eliminating needless data transfers.
Unfortunately, Trojitá is at the mercy of the IMAP server when it comes to superfluous data transfers, so it cannot
prevent the ``pings'' sent even when the connection does not contain a gateway with overly short timeouts.

\section{Improving Mailbox Synchronization}

The previous section dealt with optimizing the overall IMAP protocol as a whole.  At this stage, we can have a look at
more specific issues which cannot be easily overcome through generic measures like data compression using off-the-shelf
algorithms or updates to the basic protocol flows.

In the basic IMAP, neither the server not the client are required to keep any persistent state.  Clearly, it is
beneficiary for a client to keep downloaded copies of the immutable mailbox/message data (consult
\secref{sec:imap-immutable-data} in its persistent cache for some time, should the device constraints allow such a
storage.  There is still quite a lot of other data which has to be validated while the mailbox is being resynchronized.
Consider the following scenario where a mail user agent opens a mailbox with a thousand of message which has witnessed
expunges and new arrivals since the last time it was opened:

\todo[inline]{protocol interaciton demo goes here}

We can identify two steps which substantially contribute to the transferred data:

\begin{itemize}
  \item synchronizing the UIDs,
  \item updating flags.
\end{itemize}

In the rest of this section, we will have a look at optimization opportunities at each of these stages.  Please keep in
mind that some basic optimization heuristics concerning the UID synchronization were discussed in section
\secref{sec:imap-mailbox-sync} along with reasons on why these steps are necessary in clients willing to maintain an
offline cache of immutable data.

\subsection{The ESEARCH Extension}

\cite{rfc4731}

\subsection{Avoiding Flags Resynchronization via CONDSTORE}

\cite{rfc4551}

\subsection{Optimizing UID Synchronization with QRESYNC}

\cite{rfc5162}

\section{Fetching the Data}

\subsection{The BINARY Extension}

\cite{rfc3516}

\subsection{Server-side Conversions via CONVERT}

\cite{rfc5259}

\section{Updating Mailboxes}

\subsection{Sorting, Searching  and Threading}

\cite{rfc5256}
\cite{rfc5957}

\subsection{Incremental Sorting and Searching}

\cite{rfc5267}

\subsection{Refreshing Statistics}

\cite{rfc5465}

\section{Further Improvements}

\subsection{Debugging}

\subsection{Sending Mail}

\end{document}
